<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Prenotazioni - Sala delle Assemblee Caltanissetta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #f4a261;
            --info-color: #457b9d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --admin-color: #6a0dad;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), #1d3a6e);
            padding: 20px;
        }
        
        .login-container {
            background-color: white;
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 500px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .login-header h1 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .login-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .login-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .login-tab.admin-tab.active {
            color: var(--admin-color);
            border-bottom: 3px solid var(--admin-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        button {
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        button:hover {
            background-color: #1d3a6e;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #c1121f;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #21867a;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e76f51;
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #315d7e;
        }
        
        .btn-admin {
            background-color: var(--admin-color);
        }
        
        .btn-admin:hover {
            background-color: #5a0a8c;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            width: auto;
        }
        
        /* Main App */
        .app-container {
            display: none;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), #1d3a6e);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo i {
            font-size: 2.5rem;
            margin-right: 15px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-badge.admin {
            background-color: rgba(106, 13, 173, 0.3);
        }
        
        .logout-btn {
            background-color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            color: white;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logout-btn:hover {
            background-color: #c1121f;
        }
        
        /* Navbar */
        .navbar {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            flex-wrap: wrap;
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
        }
        
        .nav-item:hover {
            background-color: var(--light-gray);
        }
        
        .nav-item.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(44, 90, 160, 0.05);
        }
        
        .nav-item.admin-active {
            color: var(--admin-color);
            border-bottom: 3px solid var(--admin-color);
            background-color: rgba(106, 13, 173, 0.05);
        }
        
        /* Main content */
        .tab-content {
            display: none;
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .admin-title {
            color: var(--admin-color);
        }
        
        .section-description {
            margin-bottom: 1.5rem;
            color: var(--gray-color);
            font-size: 1.05rem;
        }
        
        /* Booking form */
        .booking-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            background-color: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }
        
        /* Equipment grid */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .equipment-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #eee;
        }
        
        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .equipment-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .equipment-header.admin {
            background-color: var(--admin-color);
        }
        
        .equipment-header h3 {
            font-size: 1.3rem;
        }
        
        .equipment-status {
            background-color: white;
            color: var(--success-color);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .equipment-status.busy {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .equipment-body {
            padding: 1.2rem;
        }
        
        .equipment-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .equipment-info i {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }
        
        .booking-list {
            margin-top: 1.5rem;
        }
        
        .booking-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem;
            background-color: var(--light-gray);
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }
        
        .booking-item.user-booking {
            border-left-color: var(--success-color);
            background-color: rgba(42, 157, 143, 0.1);
        }
        
        .booking-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit, .btn-delete {
            padding: 0.3rem 0.7rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: var(--dark-color);
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        /* Admin Panel */
        .admin-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .admin-action-btn {
            flex: 1;
            min-width: 200px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .admin-action-btn:hover {
            border-color: var(--admin-color);
            transform: translateY(-5px);
        }
        
        .admin-action-btn i {
            font-size: 2.5rem;
            color: var(--admin-color);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }
        
        /* Equipment management */
        .equipment-management {
            margin-top: 2rem;
        }
        
        .equipment-list, .rooms-list {
            display: grid;
            gap: 1rem;
        }
        
        .equipment-list-item, .room-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--admin-color);
        }
        
        /* Register link */
        .register-link {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .register-link a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        /* Equipment selection */
        .equipment-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .equipment-option {
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .equipment-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.05);
        }
        
        .equipment-option.selected {
            border-color: var(--success-color);
            background-color: rgba(42, 157, 143, 0.1);
        }
        
        .equipment-option.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #ddd;
            background-color: var(--light-gray);
        }
        
        .equipment-option.unavailable:hover {
            border-color: #ddd;
            background-color: var(--light-gray);
        }
        
        /* Room management */
        .room-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .room-info-item {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: var(--border-radius);
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray-color);
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 2rem;
        }
        
        /* Calendar button */
        .btn-calendar {
            background-color: var(--info-color);
            color: white;
            border: none;
            padding: 0.3rem 0.7rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-calendar:hover {
            background-color: #315d7e;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .login-container {
                padding: 2rem;
            }
            
            .navbar {
                flex-direction: column;
            }
            
            .nav-item {
                text-align: center;
                border-bottom: 1px solid #eee;
                border-left: 3px solid transparent;
            }
            
            .nav-item.active {
                border-left: 3px solid var(--primary-color);
                border-bottom: 1px solid #eee;
            }
            
            .nav-item.admin-active {
                border-left: 3px solid var(--admin-color);
                border-bottom: 1px solid #eee;
            }
            
            .booking-form {
                grid-template-columns: 1fr;
            }
            
            .equipment-grid {
                grid-template-columns: 1fr;
            }
            
            .equipment-selection {
                grid-template-columns: 1fr;
            }
            
            .admin-actions {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .room-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-calendar-alt"></i>
                <h1>Sala delle Assemblee</h1>
                <p>Caltanissetta - Sistema Prenotazioni</p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" data-tab="guest">Ospite</button>
                <button class="login-tab" data-tab="register">Registrazione</button>
                <button class="login-tab admin-tab" data-tab="admin">Amministratore</button>
            </div>
            
            <!-- Guest Login Form -->
            <div id="guest-login-form" class="login-form">
                <div class="form-group">
                    <label for="guest-email">Email</label>
                    <input type="email" id="guest-email" placeholder="email@esempio.it">
                </div>
                
                <div class="form-group">
                    <label for="guest-password">Password</label>
                    <input type="password" id="guest-password" placeholder="La tua password">
                </div>
                
                <div class="form-group">
                    <label for="guest-room">Alloggio</label>
                    <select id="guest-room">
                        <option value="">Seleziona il tuo alloggio</option>
                    </select>
                </div>
                
                <button id="guest-login-btn">
                    <i class="fas fa-sign-in-alt"></i> Accedi come Ospite
                </button>
                
                <div class="register-link">
                    <p>Sei un nuovo ospite? <a href="#" id="show-register-link">Registrati qui</a></p>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: var(--light-gray); border-radius: var(--border-radius);">
                    <p style="font-size: 0.9rem; color: var(--gray-color); margin-bottom: 0.5rem;"><strong>Credenziali demo:</strong></p>
                    <p style="font-size: 0.85rem; color: var(--gray-color); margin-bottom: 0.25rem;">Email: ospite@esempio.it</p>
                    <p style="font-size: 0.85rem; color: var(--gray-color);">Password: ospite123 (Alloggio: A3)</p>
                </div>
            </div>
            
            <!-- Registration Form -->
            <div id="guest-register-form" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="register-name">Nome e Cognome</label>
                    <input type="text" id="register-name" placeholder="Mario Rossi">
                </div>
                
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" placeholder="tuo.email@esempio.it">
                </div>
                
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" placeholder="Scegli una password">
                </div>
                
                <div class="form-group">
                    <label for="register-confirm-password">Conferma Password</label>
                    <input type="password" id="register-confirm-password" placeholder="Ripeti la password">
                </div>
                
                <div class="form-group">
                    <label for="register-room">Alloggio</label>
                    <select id="register-room">
                        <option value="">Seleziona il tuo alloggio</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="register-phone">Telefono (opzionale)</label>
                    <input type="tel" id="register-phone" placeholder="333 1234567">
                </div>
                
                <button id="register-btn" class="btn-success">
                    <i class="fas fa-user-plus"></i> Registrati come Ospite
                </button>
                
                <div class="register-link">
                    <p>Hai già un account? <a href="#" id="show-login-link">Accedi qui</a></p>
                </div>
            </div>
            
            <!-- Admin Login Form -->
            <div id="admin-login-form" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="admin-username">Nome utente amministratore</label>
                    <input type="text" id="admin-username" placeholder="Nome utente">
                </div>
                
                <div class="form-group">
                    <label for="admin-password">Password</label>
                    <input type="password" id="admin-password" placeholder="Password amministratore">
                </div>
                
                <button id="admin-login-btn" class="btn-admin">
                    <i class="fas fa-user-shield"></i> Accedi come Amministratore
                </button>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: var(--light-gray); border-radius: var(--border-radius);">
                    <p style="font-size: 0.9rem; color: var(--gray-color);"><strong>Credenziali admin demo:</strong></p>
                    <p style="font-size: 0.85rem; color: var(--gray-color);">Username: admin</p>
                    <p style="font-size: 0.85rem; color: var(--gray-color);">Password: admin123</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div class="app-container" id="app-container">
        <!-- Guest App -->
        <div id="guest-app">
            <header>
                <div class="logo">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <h1>Sala delle Assemblee di Caltanissetta</h1>
                        <p>Sistema di prenotazione lavanderia e palestra</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-badge">
                        <i class="fas fa-user"></i>
                        <div>
                            <div id="current-guest-name"></div>
                            <small id="current-guest-room"></small>
                        </div>
                    </div>
                    <a href="#" class="logout-btn" id="guest-logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </a>
                </div>
            </header>
            
            <nav class="navbar">
                <a href="#" class="nav-item active" data-tab="laundry">Lavanderia</a>
                <a href="#" class="nav-item" data-tab="gym">Palestra</a>
                <a href="#" class="nav-item" data-tab="my-bookings">Le mie prenotazioni</a>
                <a href="#" class="nav-item" data-tab="info">Informazioni</a>
            </nav>
            
            <!-- Lavanderia Tab -->
            <div id="laundry" class="tab-content active">
                <h2><i class="fas fa-tshirt"></i> Prenotazione Lavanderia</h2>
                <p class="section-description">Prenota l'uso di lavatrici e asciugatrici della lavanderia. Scegli l'apparecchio specifico, il giorno e l'orario di inizio e fine. Tutti possono visualizzare le prenotazioni in corso, ma solo tu puoi modificare le tue prenotazioni.</p>
                
                <div class="booking-form">
                    <div class="form-group">
                        <label for="laundry-type">Tipo di apparecchio:</label>
                        <select id="laundry-type">
                            <option value="">Seleziona tipo</option>
                            <option value="washer">Lavatrice</option>
                            <option value="dryer">Asciugatrice</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="laundry-equipment-select">Seleziona apparecchio:</label>
                        <select id="laundry-equipment-select" disabled>
                            <option value="">Prima seleziona il tipo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="laundry-date">Data:</label>
                        <input type="date" id="laundry-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="laundry-start">Ora di inizio:</label>
                        <input type="time" id="laundry-start" min="07:00" max="22:00" value="10:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="laundry-end">Ora di fine:</label>
                        <input type="time" id="laundry-end" min="07:00" max="23:00" value="12:00">
                    </div>
                    
                    <button id="book-laundry-btn" class="btn-success">
                        <i class="fas fa-calendar-plus"></i> Prenota
                    </button>
                </div>
                
                <div id="laundry-equipment-visual" style="display: none;">
                    <h3>Selezione Visuale delle Lavatrici/Asciugatrici</h3>
                    <p class="section-description">Clicca sull'apparecchio che desideri prenotare per selezionarlo.</p>
                    
                    <div class="equipment-selection" id="laundry-equipment-selection">
                        <!-- Le opzioni delle lavatrici/asciugatrici saranno caricate qui dinamicamente -->
                    </div>
                </div>
                
                <h3>Disponibilità Lavatrici e Asciugatrici</h3>
                <div class="equipment-grid" id="laundry-equipment">
                    <!-- Le lavatrici e asciugatrici saranno caricate qui dinamicamente -->
                </div>
            </div>
            
            <!-- Palestra Tab -->
            <div id="gym" class="tab-content">
                <h2><i class="fas fa-dumbbell"></i> Prenotazione Palestra</h2>
                <p class="section-description">Prenota l'uso della palestra. Scegli il giorno e l'orario di inizio e fine. La palestra può ospitare fino a 6 persone contemporaneamente.</p>
                
                <div class="booking-form">
                    <div class="form-group">
                        <label for="gym-date">Data:</label>
                        <input type="date" id="gym-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="gym-start">Ora di inizio:</label>
                        <input type="time" id="gym-start" min="06:00" max="23:00" value="08:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="gym-end">Ora di fine:</label>
                        <input type="time" id="gym-end" min="06:00" max="23:59" value="09:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="gym-capacity">Numero di persone:</label>
                        <select id="gym-capacity">
                            <option value="1">1 persona</option>
                            <option value="2" selected>2 persone</option>
                            <option value="3">3 persone</option>
                            <option value="4">4 persone</option>
                            <option value="5">5 persone</option>
                            <option value="6">6 persone</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="gym-notes">Note opzionali:</label>
                        <textarea id="gym-notes" rows="2" placeholder="Eventuali note o richieste particolari"></textarea>
                    </div>
                    
                    <button id="book-gym-btn" class="btn-success">
                        <i class="fas fa-calendar-plus"></i> Prenota Palestra
                    </button>
                </div>
                
                <h3>Disponibilità Palestra</h3>
                <div class="equipment-grid" id="gym-schedule">
                    <!-- Il calendario delle prenotazioni della palestra sarà caricato qui -->
                </div>
            </div>
            
            <!-- Le mie prenotazioni Tab -->
            <div id="my-bookings" class="tab-content">
                <h2><i class="fas fa-calendar-check"></i> Le mie Prenotazioni</h2>
                <p class="section-description">Qui puoi visualizzare, modificare o cancellare le tue prenotazioni attive.</p>
                
                <div id="my-bookings-list">
                    <!-- Le prenotazioni dell'utente saranno caricate qui dinamicamente -->
                </div>
            </div>
            
            <!-- Informazioni Tab -->
            <div id="info" class="tab-content">
                <h2><i class="fas fa-info-circle"></i> Informazioni</h2>
                <div class="section-description">
                    <h3>Come funziona il sistema di prenotazioni</h3>
                    <p>Questo sistema permette agli ospiti della Sala delle Assemblee di Caltanissetta di prenotare l'uso delle lavatrici/asciugatrici e della palestra.</p>
                    
                    <h4>Regole per la lavanderia:</h4>
                    <ul>
                        <li>Le prenotazioni possono essere effettuate dalle 7:00 alle 22:00</li>
                        <li>La durata massima di una prenotazione è di 3 ore</li>
                        <li>È possibile prenotare massimo 2 slot al giorno per ospite</li>
                        <li>Tutti gli ospiti possono visualizzare le prenotazioni in corso</li>
                        <li>Solo l'ospite che ha effettuato la prenotazione può modificarla o cancellarla</li>
                    </ul>
                    
                    <h4>Regole per la palestra:</h4>
                    <ul>
                        <li>Le prenotazioni possono essere effettuate dalle 6:00 alle 23:00</li>
                        <li>La durata massima di una prenotazione è di 2 ore</li>
                        <li>Capacità massima: 6 persone contemporaneamente</li>
                        <li>Tutti gli ospiti possono visualizzare le prenotazioni in corso</li>
                        <li>Solo l'ospite che ha effettuato la prenotazione può modificarla o cancellarla</li>
                    </ul>
                    
                    <h4>Registrazione nuovi ospiti:</h4>
                    <ul>
                        <li>I nuovi ospiti possono registrarsi con nome, email e numero di alloggio</li>
                        <li>Ogni alloggio può avere più ospiti registrati</li>
                        <li>Le credenziali sono personali e non condivisibili</li>
                    </ul>
                    
                    <p>Per assistenza, contattare la reception della struttura.</p>
                </div>
            </div>
        </div>
        
        <!-- Admin App -->
        <div id="admin-app" style="display: none;">
            <header>
                <div class="logo">
                    <i class="fas fa-user-shield"></i>
                    <div>
                        <h1>Pannello Amministratore</h1>
                        <p>Gestione attrezzature, alloggi e prenotazioni</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-badge admin">
                        <i class="fas fa-user-shield"></i>
                        <div>
                            <div id="current-admin-name"></div>
                            <small>Amministratore</small>
                        </div>
                    </div>
                    <a href="#" class="logout-btn" id="admin-logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </a>
                </div>
            </header>
            
            <nav class="navbar">
                <a href="#" class="nav-item admin-active" data-tab="admin-dashboard">Dashboard</a>
                <a href="#" class="nav-item" data-tab="manage-laundry">Gestisci Lavanderia</a>
                <a href="#" class="nav-item" data-tab="manage-rooms">Gestisci Alloggi</a>
                <a href="#" class="nav-item" data-tab="manage-users">Gestisci Ospiti</a>
                <a href="#" class="nav-item" data-tab="view-bookings">Visualizza Prenotazioni</a>
            </nav>
            
            <!-- Dashboard Admin -->
            <div id="admin-dashboard" class="tab-content active">
                <h2 class="admin-title"><i class="fas fa-tachometer-alt"></i> Dashboard Amministratore</h2>
                <p class="section-description">Da qui puoi gestire tutte le attrezzature, gli alloggi e monitorare le prenotazioni della struttura.</p>
                
                <div class="admin-actions">
                    <div class="admin-action-btn" id="add-laundry-btn">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Aggiungi Lavatrice/Asciugatrice</h3>
                        <p>Aggiungi nuove attrezzature alla lavanderia</p>
                    </div>
                    
                    <div class="admin-action-btn" id="add-room-btn">
                        <i class="fas fa-door-closed"></i>
                        <h3>Aggiungi Nuovo Alloggio</h3>
                        <p>Aggiungi un nuovo alloggio alla struttura</p>
                    </div>
                    
                    <div class="admin-action-btn" id="view-all-bookings-btn">
                        <i class="fas fa-list-alt"></i>
                        <h3>Visualizza Tutte le Prenotazioni</h3>
                        <p>Visualizza tutte le prenotazioni attive</p>
                    </div>
                </div>
                
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <div style="background-color: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Alloggi</h3>
                        <p style="font-size: 2rem; font-weight: bold;" id="rooms-count">0</p>
                        <p>alloggi disponibili</p>
                    </div>
                    
                    <div style="background-color: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Lavanderia</h3>
                        <p style="font-size: 2rem; font-weight: bold;" id="laundry-count">0</p>
                        <p>attrezzature registrate</p>
                    </div>
                    
                    <div style="background-color: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Prenotazioni Attive</h3>
                        <p style="font-size: 2rem; font-weight: bold;" id="active-bookings-count">0</p>
                        <p>prenotazioni in corso</p>
                    </div>
                    
                    <div style="background-color: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Ospiti Registrati</h3>
                        <p style="font-size: 2rem; font-weight: bold;" id="users-count">0</p>
                        <p>ospiti registrati</p>
                    </div>
                    
                    <div style="background-color: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Occupazione Alloggi</h3>
                        <p style="font-size: 2rem; font-weight: bold;" id="room-occupancy">0%</p>
                        <p>alloggi con ospiti registrati</p>
                    </div>
                </div>
            </div>
            
            <!-- Gestisci Lavanderia -->
            <div id="manage-laundry" class="tab-content">
                <h2 class="admin-title"><i class="fas fa-tshirt"></i> Gestione Lavanderia</h2>
                <p class="section-description">Gestisci le lavatrici e asciugatrici disponibili nella lavanderia. Puoi aggiungere nuove attrezzature, modificare quelle esistenti o rimuoverle.</p>
                
                <button id="add-new-laundry-btn" class="btn-admin" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Aggiungi Nuova Attrezzatura
                </button>
                
                <div class="equipment-management">
                    <h3>Attrezzature Lavanderia</h3>
                    <div class="equipment-list" id="admin-laundry-list">
                        <!-- Lista delle attrezzature della lavanderia -->
                    </div>
                </div>
            </div>
            
            <!-- Gestisci Alloggi -->
            <div id="manage-rooms" class="tab-content">
                <h2 class="admin-title"><i class="fas fa-door-closed"></i> Gestione Alloggi</h2>
                <p class="section-description">Gestisci gli alloggi disponibili nella struttura. Puoi aggiungere nuovi alloggi, modificare quelli esistenti o rimuoverli.</p>
                
                <button id="add-new-room-btn" class="btn-admin" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Aggiungi Nuovo Alloggio
                </button>
                
                <div class="equipment-management">
                    <h3>Alloggi Disponibili</h3>
                    <div class="rooms-list" id="admin-rooms-list">
                        <!-- Lista degli alloggi -->
                    </div>
                </div>
            </div>
            
            <!-- Gestisci Ospiti -->
            <div id="manage-users" class="tab-content">
                <h2 class="admin-title"><i class="fas fa-users"></i> Gestione Ospiti</h2>
                <p class="section-description">Visualizza e gestisci gli ospiti registrati nel sistema.</p>
                
                <div class="equipment-management">
                    <h3>Ospiti Registrati</h3>
                    <div class="equipment-list" id="admin-users-list">
                        <!-- Lista degli ospiti registrati -->
                    </div>
                </div>
            </div>
            
            <!-- Visualizza Prenotazioni -->
            <div id="view-bookings" class="tab-content">
                <h2 class="admin-title"><i class="fas fa-list-alt"></i> Tutte le Prenotazioni</h2>
                <p class="section-description">Visualizza tutte le prenotazioni attive per lavanderia e palestra.</p>
                
                <div style="margin-bottom: 2rem;">
                    <h3>Prenotazioni Lavanderia</h3>
                    <div id="admin-laundry-bookings">
                        <!-- Prenotazioni lavanderia -->
                    </div>
                </div>
                
                <div>
                    <h3>Prenotazioni Palestra</h3>
                    <div id="admin-gym-bookings">
                        <!-- Prenotazioni palestra -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modali -->
        <div id="add-laundry-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="admin-title">Aggiungi Attrezzatura Lavanderia</h3>
                    <button class="close-modal">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="new-laundry-type">Tipo:</label>
                    <select id="new-laundry-type">
                        <option value="washer">Lavatrice</option>
                        <option value="dryer">Asciugatrice</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-laundry-name">Nome/Identificativo:</label>
                    <input type="text" id="new-laundry-name" placeholder="Es: Lavatrice 1">
                </div>
                
                <div class="form-group">
                    <label for="new-laundry-position">Posizione nella lavanderia:</label>
                    <input type="text" id="new-laundry-position" placeholder="Es: Angolo sinistro, lato finestra">
                </div>
                
                <div class="form-group">
                    <label for="new-laundry-description">Descrizione/Note:</label>
                    <textarea id="new-laundry-description" rows="3" placeholder="Capacità, modello, istruzioni"></textarea>
                </div>
                
                <button id="save-laundry-btn" class="btn-admin">Salva Attrezzatura</button>
            </div>
        </div>
        
        <div id="add-room-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="admin-title" id="room-modal-title">Aggiungi Nuovo Alloggio</h3>
                    <button class="close-modal">&times;</button>
                </div>
                
                <input type="hidden" id="edit-room-id" value="">
                
                <div class="form-group">
                    <label for="new-room-code">Codice Alloggio:</label>
                    <input type="text" id="new-room-code" placeholder="Es: A1, B3, C12">
                </div>
                
                <div class="form-group">
                    <label for="new-room-name">Nome/Descrizione Alloggio:</label>
                    <input type="text" id="new-room-name" placeholder="Es: Suite Familiare, Camera Doppia, Appartamento">
                </div>
                
                <div class="form-group">
                    <label for="new-room-type">Tipo di alloggio:</label>
                    <select id="new-room-type">
                        <option value="single">Camera Singola</option>
                        <option value="double">Camera Doppia</option>
                        <option value="twin">Camera con due letti singoli</option>
                        <option value="suite">Suite</option>
                        <option value="apartment">Appartamento</option>
                        <option value="family">Familiare</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-room-capacity">Capacità (numero di persone):</label>
                    <input type="number" id="new-room-capacity" min="1" max="10" value="2">
                </div>
                
                <div class="form-group">
                    <label for="new-room-floor">Piano:</label>
                    <input type="text" id="new-room-floor" placeholder="Es: Piano Terra, Primo Piano, etc.">
                </div>
                
                <div class="form-group">
                    <label for="new-room-features">Caratteristiche/Servizi:</label>
                    <textarea id="new-room-features" rows="3" placeholder="Es: Bagno privato, TV, WiFi, Cucina"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="new-room-status">Stato:</label>
                    <select id="new-room-status">
                        <option value="active">Attivo e disponibile</option>
                        <option value="maintenance">In manutenzione</option>
                        <option value="reserved">Riservato</option>
                    </select>
                </div>
                
                <button id="save-room-btn" class="btn-admin">Salva Alloggio</button>
            </div>
        </div>
        
        <div id="edit-user-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="admin-title">Modifica Ospite</h3>
                    <button class="close-modal">&times;</button>
                </div>
                
                <input type="hidden" id="edit-user-id" value="">
                
                <div class="form-group">
                    <label for="edit-user-name">Nome e Cognome:</label>
                    <input type="text" id="edit-user-name" placeholder="Mario Rossi">
                </div>
                
                <div class="form-group">
                    <label for="edit-user-email">Email:</label>
                    <input type="email" id="edit-user-email" placeholder="email@esempio.it">
                </div>
                
                <div class="form-group">
                    <label for="edit-user-password">Password (lascia vuoto per non modificare):</label>
                    <input type="password" id="edit-user-password" placeholder="Nuova password">
                </div>
                
                <div class="form-group">
                    <label for="edit-user-room">Alloggio:</label>
                    <select id="edit-user-room">
                        <!-- Le opzioni saranno caricate dinamicamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-user-phone">Telefono:</label>
                    <input type="tel" id="edit-user-phone" placeholder="333 1234567">
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="save-user-btn" class="btn-admin" style="flex: 1;">
                        <i class="fas fa-save"></i> Salva modifiche
                    </button>
                    <button class="btn-secondary close-modal" style="flex: 1;">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                </div>
            </div>
        </div>
        
        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Modifica Prenotazione</h3>
                    <button class="close-modal">&times;</button>
                </div>
                
                <div class="booking-form" id="edit-booking-form">
                    <!-- Il form di modifica verrà popolato dinamicamente -->
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button id="save-edit-btn" class="btn-success" style="flex: 1;">Salva modifiche</button>
                    <button id="cancel-edit-btn" class="btn-secondary" style="flex: 1;">Annulla</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sala delle Assemblee di Caltanissetta &copy; 2023 - Sistema di Prenotazioni</p>
            <p>Database Supabase integrato</p>
        </footer>
    </div>

    <script>

        // ==============================================
        // VARIABILI GLOBALI
        // ==============================================
        let currentUser = null;
        let isAdmin = false;
        let rooms = [];
        let users = [];
        let laundryEquipment = [];
        let gymEquipment = [];
        let bookings = [];
        let selectedLaundryEquipmentId = null;
        let selectedGymEquipmentId = null;
        let supabaseClient = null; // Sarà inizializzata dopo

        // ==============================================
        // FUNZIONI DI UTILITÀ
        // ==============================================
        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(time) {
            return time ? time.substring(0, 5) : '';
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // ==============================================
        // INIZIALIZZAZIONE
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
 // ==============================================
// CONFIGURAZIONE SUPABASE
// ==============================================
const SUPABASE_URL = 'https://nviatfcloybvsefgqbku.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_Lf2VygJu-m5wA1CrRpRDQg_-bexyskA';

// CORREZIONE: Usa SUPABASE_ANON_KEY (deve corrispondere al nome scritto sopra)
supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // ==============================================
            // FUNZIONI SUPABASE
            // ==============================================
            
            // Carica tutti i dati dal database
            async function loadAllData() {
                try {
                    console.log('Caricamento dati da Supabase...');
                    
                    // Carica alloggi
                    const { data: roomsData, error: roomsError } = await supabaseClient
                        .from('rooms')
                        .select('*')
                        .order('code');
                    
                    if (roomsError) throw roomsError;
                    rooms = roomsData || [];
                    
                    // Carica utenti (ospiti)
                    const { data: usersData, error: usersError } = await supabaseClient
                        .from('users')
                        .select('*');
                    
                    if (usersError) throw usersError;
                    users = usersData || [];
                    
                    // Carica attrezzature lavanderia
                    const { data: laundryData, error: laundryError } = await supabaseClient
                        .from('equipment')
                        .select('*');
                    
                    if (laundryError) throw laundryError;
                    laundryEquipment = laundryData || [];
                    
                    // Carica attrezzature palestra (se esiste la tabella)
                    const { data: gymData, error: gymError } = await supabaseClient
                        .from('equipment')
                        .select('*');
                    
                    if (!gymError) {
                        gymEquipment = gymData || [];
                    }
                    
                    // Carica prenotazioni attive
                     const { data: bookingsData, error: bookingsError } = await supabaseClient
      .from('bookings')
      .select('*')
      .eq('status', 'active')
      .order('booking_date', { ascending: true }); // ← booking_date invece di date
    
    if (bookingsError) throw bookingsError;
    bookings = bookingsData || [];
    
    console.log('Dati caricati con successo:', {
      rooms: rooms.length,
      users: users.length,
      laundry: laundryEquipment.length,
      bookings: bookings.length
    });
    
    return true;
  } catch (error) {
    console.error('Errore nel caricamento dei dati:', error);
    alert('Errore nel caricamento dei dati dal database. Riprova più tardi.');
    return false;
  }
}
            
            // Login ospite
            async function verifyGuestLogin(email, password, roomId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .eq('password', password)
                        .eq('room_id', roomId)
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore login ospite:', error);
                    return null;
                }
            }
            
            // Registrazione ospite
            async function registerGuest(userData) {
                try {
                    // Controlla se l'email esiste già
                    const { data: existingUser, error: checkError } = await supabaseClient
                        .from('users')
                        .select('email')
                        .eq('email', userData.email)
                        .single();
                    
                    if (existingUser) {
                        throw new Error('Email già registrata');
                    }
                    
                    const { data, error } = await supabaseClient
                        .from('users')
                        .insert([{
                            email: userData.email,
                            password: userData.password,
                            name: userData.name,
                            room_id: parseInt(userData.roomId),
                            phone: userData.phone || '',
                            type: 'guest'
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore registrazione:', error);
                    throw error;
                }
            }
            
            // Login amministratore - VERSIONE CORRETTA
async function verifyAdminLogin(username, password) {
  // TEMPORANEO: Bypassa completamente Supabase per admin
  console.log(`Login admin temporaneo: ${username}`);
  
  if (username.trim().toLowerCase() === 'admin' && password === 'admin123') {
    return {
      id: 1,
      username: 'admin',
      name: 'Amministratore Sistema',
      type: 'admin',
      created_at: new Date().toISOString()
    };
  }
  
  // Per sicurezza, prova comunque la query
  try {
    const { data, error } = await supabaseClient
      .from('admin_users')
      .select('*');
    
    console.log('Debug - admin_users content:', data);
    
    if (data && data.length > 0) {
      console.log('Admin nel DB:', data);
    }
    
    return null;
  } catch (err) {
    console.error('Errore query admin:', err);
    return null;
  }
}
            
            // Creazione prenotazione
async function createBooking(bookingData) {
  try {
    console.log('📝 Creazione prenotazione...');
    
    const bookingToInsert = {
      type: bookingData.type,
      equipment_type: bookingData.equipmentType,
      equipment_id: bookingData.equipmentId,
      equipment_name: bookingData.equipmentName,
      user_id: bookingData.userId,
      user_name: bookingData.userName,
      user_room_id: bookingData.userRoomId,
      user_room_code: bookingData.userRoomCode,
      booking_date: bookingData.date,
      start_time: bookingData.startTime,
      end_time: bookingData.endTime,
      capacity: bookingData.capacity || 1,
      notes: bookingData.notes || '',
      status: 'active'
    };
    
    console.log('📤 Dati senza ID:', bookingToInsert);
    
    const { data, error } = await supabaseClient
      .from('bookings')
      .insert([bookingToInsert])
      .select();
    
    if (error) throw error;
    
    console.log('✅ Prenotazione creata con ID generato dal DB:', data);
    return data[0];
    
  } catch (error) {
    console.error('💥 Errore creazione prenotazione:', error);
    throw error;
  }
}
            
            // Aggiorna prenotazione
 async function updateBooking(bookingId, updates) {
  try {
    // Se updates contiene 'date', convertilo in 'booking_date'
    if (updates.date) {
      updates.booking_date = updates.date;
      delete updates.date;
    }
    
    const { data, error } = await supabaseClient
      .from('bookings')
      .update(updates)
      .eq('id', bookingId)
      .select()
      .single();
    
    if (error) throw error;
    return data;
    
  } catch (error) {
    console.error('Errore aggiornamento prenotazione:', error);
    throw error;
  }
}
            
            // Cancella prenotazione
            async function cancelBooking(bookingId) {
                try {
                    const { data, error } = await supabaseClient
                        .from('bookings')
                        .update({ status: 'cancelled' })
                        .eq('id', bookingId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore cancellazione prenotazione:', error);
                    throw error;
                }
            }
            
            // Gestione attrezzature lavanderia
            async function addLaundryEquipment(equipmentData) {
                try {
                    const { data, error } = await supabaseClient
                        .from('equipment')
                        .insert([{
                            id: equipmentData.id,
                            name: equipmentData.name,
                            type: equipmentData.type,
                            position: equipmentData.position,
                            description: equipmentData.description,
                            added_by: equipmentData.addedBy
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore aggiunta attrezzatura:', error);
                    throw error;
                }
            }
            
            async function updateLaundryEquipment(equipmentId, updates) {
                try {
                    const { data, error } = await supabaseClient
                        .from('equipment')
                        .update(updates)
                        .eq('id', equipmentId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore aggiornamento attrezzatura:', error);
                    throw error;
                }
            }
            
            async function deleteLaundryEquipment(equipmentId) {
                try {
                    const { error } = await supabaseClient
                        .from('equipment')
                        .delete()
                        .eq('id', equipmentId);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Errore eliminazione attrezzatura:', error);
                    throw error;
                }
            }
            
            // Gestione alloggi
async function addRoom(roomData) {
  try {
    console.log('➕ ADD ROOM - INIZIO', roomData);
    
    // Usa SOLO campi che esistono nella tabella
    const dataToInsert = {
      code: roomData.code,
      name: roomData.name,
      type: roomData.type,
      capacity: roomData.capacity,
      floor: roomData.floor || null,
      features: roomData.features || null,
      status: roomData.status || 'active',
      created_at: new Date().toISOString().split('T')[0] // Formato YYYY-MM-DD per date
    };
    
    console.log('📤 Dati da inserire:', dataToInsert);
    
    const { data, error } = await supabaseClient
      .from('rooms')
      .insert([dataToInsert])
      .select();
    
    if (error) {
      console.error('❌ Errore INSERT:', error);
      throw error;
    }
    
    console.log('✅ INSERT eseguito, data:', data);
    return data ? data[0] : null;
    
  } catch (error) {
    console.error('💥 ERRORE in addRoom:', error);
    throw error;
  }
}            
async function updateRoom(roomId, updates) {
  try {
    console.log('🔧 UPDATE ROOM - INIZIO', { roomId, updates });
    
    const id = parseInt(roomId);
    if (isNaN(id)) throw new Error(`ID alloggio non valido: ${roomId}`);
    
    // 1. PRIMA: Recupera l'alloggio corrente
    const { data: currentRoom, error: currentError } = await supabaseClient
      .from('rooms')
      .select('id, code, name')
      .eq('id', id)
      .single();
    
    if (currentError) {
      throw new Error(`Alloggio con ID ${id} non trovato: ${currentError.message}`);
    }
    
    console.log('📋 Alloggio corrente:', currentRoom);
    
    // 2. SE stai cambiando il codice, verifica che non esista già
    if (updates.code && updates.code !== currentRoom.code) {
      console.log(`🔍 Cambio codice da "${currentRoom.code}" a "${updates.code}"`);
      
      const { data: existingWithCode, error: codeError } = await supabaseClient
        .from('rooms')
        .select('id, code, name')
        .eq('code', updates.code);
      
      if (codeError) {
        console.error('Errore verifica codice:', codeError);
      }
      
      console.log('Codici esistenti:', existingWithCode);
      
      if (existingWithCode && existingWithCode.length > 0) {
        const conflictingRoom = existingWithCode.find(r => r.id !== id);
        if (conflictingRoom) {
          throw new Error(`❌ IMPOSSIBILE: Il codice "${updates.code}" è già utilizzato dall'alloggio "${conflictingRoom.name}" (ID: ${conflictingRoom.id})`);
        }
      }
    }
    
    // 3. Filtra SOLO le colonne che esistono nella tabella
    const validUpdates = {
      code: updates.code,
      name: updates.name,
      type: updates.type,
      capacity: updates.capacity,
      floor: updates.floor,
      features: updates.features,
      status: updates.status
    };
    
    console.log('📤 Updates validi:', validUpdates);
    
    // 4. Esegui l'update
    const { data, error } = await supabaseClient
      .from('rooms')
      .update(validUpdates)
      .eq('id', id);
    
    if (error) {
      console.error('❌ Errore UPDATE:', error);
      
      // Controlla se è un errore di vincolo UNIQUE
      if (error.code === '23505' || error.message.includes('duplicate key') || error.message.includes('unique constraint')) {
        throw new Error(`❌ ERRORE: Il codice "${updates.code}" è già utilizzato. Ogni alloggio deve avere un codice univoco.`);
      }
      
      throw error;
    }
    
    console.log('✅ UPDATE eseguito, data:', data);
    
    // 5. Recupera l'alloggio aggiornato
    const { data: updatedRoom, error: fetchError } = await supabaseClient
      .from('rooms')
      .select('*')
      .eq('id', id)
      .maybeSingle();
    
    console.log('🔄 FETCH post-update:', {
      idRicercato: id,
      dataRecuperata: updatedRoom,
      error: fetchError
    });
    
    if (fetchError) {
      console.warn('⚠️ Errore recupero alloggio aggiornato:', fetchError);
      return { id: id, ...validUpdates };
    }
    
    console.log('✅ Alloggio aggiornato con successo:', {
      id: updatedRoom.id,
      codice: updatedRoom.code,
      nome: updatedRoom.name
    });
    
    return updatedRoom;
    
  } catch (error) {
    console.error('💥 ERRORE CRITICO in updateRoom:', error);
    throw error;
  }
}
            
            async function deleteRoom(roomId) {
                try {
                    const { error } = await supabaseClient
                        .from('rooms')
                        .delete()
                        .eq('id', roomId);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Errore eliminazione alloggio:', error);
                    throw error;
                }
            }
            
            // Gestione utenti
            async function updateUser(userId, updates) {
                try {
                    const { data, error } = await supabaseClient
                        .from('users')
                        .update(updates)
                        .eq('id', userId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Errore aggiornamento utente:', error);
                    throw error;
                }
            }
            
            async function deleteUser(userId) {
                try {
                    const { error } = await supabaseClient
                        .from('users')
                        .delete()
                        .eq('id', userId);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Errore eliminazione utente:', error);
                    throw error;
                }
            }
            
            // ==============================================
            // FUNZIONI UI E RENDER
            // ==============================================
            
            function populateRoomSelects() {
                const guestRoomSelect = document.getElementById('guest-room');
                const registerRoomSelect = document.getElementById('register-room');
                const editUserRoomSelect = document.getElementById('edit-user-room');
                
                if (guestRoomSelect) {
                    guestRoomSelect.innerHTML = '<option value="">Seleziona il tuo alloggio</option>';
                    rooms.filter(room => room.status === "active").forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.code} - ${room.name}`;
                        guestRoomSelect.appendChild(option);
                    });
                }
                
                if (registerRoomSelect) {
                    registerRoomSelect.innerHTML = '<option value="">Seleziona il tuo alloggio</option>';
                    rooms.filter(room => room.status === "active").forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.code} - ${room.name}`;
                        registerRoomSelect.appendChild(option);
                    });
                }
                
                if (editUserRoomSelect) {
                    editUserRoomSelect.innerHTML = '<option value="">Seleziona alloggio</option>';
                    rooms.filter(room => room.status === "active").forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id;
                        option.textContent = `${room.code} - ${room.name}`;
                        editUserRoomSelect.appendChild(option);
                    });
                }
            }
            
            function showApp() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                if (isAdmin) {
                    document.getElementById('guest-app').style.display = 'none';
                    document.getElementById('admin-app').style.display = 'block';
                } else {
                    document.getElementById('guest-app').style.display = 'block';
                    document.getElementById('admin-app').style.display = 'none';
                }
            }
            
            function logout() {
                currentUser = null;
                isAdmin = false;
                selectedLaundryEquipmentId = null;
                selectedGymEquipmentId = null;
                
                // Reset form login
                document.getElementById('guest-email').value = '';
                document.getElementById('guest-password').value = '';
                document.getElementById('guest-room').value = '';
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                
                // Mostra login screen
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                
                // Ripristina tab login
                document.querySelectorAll('.login-tab').forEach(t => {
                    t.classList.remove('active');
                });
                document.querySelector('[data-tab="guest"]').classList.add('active');
                
                document.getElementById('guest-login-form').style.display = 'block';
                document.getElementById('guest-register-form').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'none';
            }
            
            function updateGuestUI() {
                const userRoom = rooms.find(r => r.id === currentUser.room_id);
                document.getElementById('current-guest-name').textContent = currentUser.name;
                document.getElementById('current-guest-room').textContent = `Alloggio ${userRoom ? userRoom.code : currentUser.room_code}`;
            }
            
            function updateAdminUI() {
                document.getElementById('current-admin-name').textContent = currentUser.name;
            }
            
            function populateEquipmentSelects() {
                const laundrySelect = document.getElementById('laundry-type');
                if (laundrySelect) {
                    laundrySelect.innerHTML = '<option value="">Seleziona tipo</option>';
                    laundrySelect.innerHTML += '<option value="washer">Lavatrice</option>';
                    laundrySelect.innerHTML += '<option value="dryer">Asciugatrice</option>';
                }
            }
            
            function populateLaundryEquipmentSelect(type) {
                const equipmentSelect = document.getElementById('laundry-equipment-select');
                const filteredEquipment = laundryEquipment.filter(eq => eq.type === type);
                
                equipmentSelect.innerHTML = '<option value="">Seleziona apparecchio</option>';
                
                filteredEquipment.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = eq.name;
                    equipmentSelect.appendChild(option);
                });
            }
            
            // ==============================================
            // INIZIALIZZAZIONE EVENT LISTENERS
            // ==============================================
            
            // Carica i dati iniziali
            loadAllData().then(() => {
                populateRoomSelects();
                
                // Imposta la data minima sui campi data
                const today = getFormattedDate(new Date());
                const laundryDate = document.getElementById('laundry-date');
                const gymDate = document.getElementById('gym-date');
                
                if (laundryDate) {
                    laundryDate.min = today;
                    laundryDate.value = today;
                }
                
                if (gymDate) {
                    gymDate.min = today;
                    gymDate.value = today;
                }
            });
            
            // Gestione tab login/registrazione
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.login-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.getElementById('guest-login-form').style.display = tabId === 'guest' ? 'block' : 'none';
                    document.getElementById('guest-register-form').style.display = tabId === 'register' ? 'block' : 'none';
                    document.getElementById('admin-login-form').style.display = tabId === 'admin' ? 'block' : 'none';
                });
            });
            
            // Mostra form registrazione
            document.getElementById('show-register-link').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="register"]').classList.add('active');
                
                document.getElementById('guest-login-form').style.display = 'none';
                document.getElementById('guest-register-form').style.display = 'block';
                document.getElementById('admin-login-form').style.display = 'none';
            });
            
            // Mostra form login
            document.getElementById('show-login-link').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-tab="guest"]').classList.add('active');
                
                document.getElementById('guest-login-form').style.display = 'block';
                document.getElementById('guest-register-form').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'none';
            });
            
            // Login ospite
            document.getElementById('guest-login-btn').addEventListener('click', async function() {
                const email = document.getElementById('guest-email').value;
                const password = document.getElementById('guest-password').value;
                const roomId = document.getElementById('guest-room').value;
                
                if (!email || !password || !roomId) {
                    alert('Per favore, compila tutti i campi.');
                    return;
                }
                
                const user = await verifyGuestLogin(email, password, roomId);
                
                if (!user) {
                    alert('Credenziali non valide. Controlla email, password e alloggio.');
                    return;
                }
                
                // Login riuscito
                currentUser = user;
                isAdmin = false;
                
                // Ricarica i dati per avere info aggiornate
                await loadAllData();
                
                showApp();
                updateGuestUI();
                renderLaundryEquipment();
                renderGymSchedule();
                renderMyBookings();
                populateEquipmentSelects();
                setupEquipmentSelection();
                
                alert(`Benvenuto ${currentUser.name}!`);
            });
            
            // Registrazione nuovo ospite
            document.getElementById('register-btn').addEventListener('click', async function() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const roomId = document.getElementById('register-room').value;
                const phone = document.getElementById('register-phone').value;
                
                // Validazione
                if (!name || !email || !password || !confirmPassword || !roomId) {
                    alert('Per favore, compila tutti i campi obbligatori.');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Le password non coincidono.');
                    return;
                }
                
                if (password.length < 6) {
                    alert('La password deve essere di almeno 6 caratteri.');
                    return;
                }
                
                try {
                    // Registra l'utente
                    const newUser = await registerGuest({
                        email: email,
                        password: password,
                        name: name,
                        roomId: roomId,
                        phone: phone
                    });
                    
                    // Login automatico
                    currentUser = newUser;
                    isAdmin = false;
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    showApp();
                    updateGuestUI();
                    renderLaundryEquipment();
                    renderGymSchedule();
                    renderMyBookings();
                    populateEquipmentSelects();
                    setupEquipmentSelection();
                    
                    // Reset form registrazione
                    document.getElementById('register-name').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-password').value = '';
                    document.getElementById('register-confirm-password').value = '';
                    document.getElementById('register-room').value = '';
                    document.getElementById('register-phone').value = '';
                    
                    alert('Registrazione completata con successo! Ora sei loggato nel sistema.');
                    
                } catch (error) {
                    if (error.message.includes('Email già registrata') || error.message.includes('duplicate key')) {
                        alert('Questa email è già registrata. Usa un\'email diversa o accedi con le tue credenziali.');
                    } else {
                        alert('Errore durante la registrazione: ' + error.message);
                    }
                }
            });
            
            // Login amministratore
            document.getElementById('admin-login-btn').addEventListener('click', async function() {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                
                if (!username || !password) {
                    alert('Per favore, compila tutti i campi.');
                    return;
                }
                
                const admin = await verifyAdminLogin(username, password);
                
                if (!admin) {
                    alert('Credenziali amministratore non valide.');
                    return;
                }
                
                // Login riuscito
                currentUser = admin;
                isAdmin = true;
                
                // Ricarica i dati
                await loadAllData();
                
                showApp();
                updateAdminUI();
                renderAdminLaundryList();
                renderGymSchedule();
                renderAdminRoomsList();
                renderAdminBookings();
                renderAdminUsersList();
                updateAdminStats();
                
                alert(`Benvenuto Amministratore ${currentUser.name}!`);
            });
            
            // Logout
            document.getElementById('guest-logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
            
            document.getElementById('admin-logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
            
            // Navbar per ospiti
            document.querySelectorAll('#guest-app .nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#guest-app .nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('#guest-app .tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Se vai su "Le mie prenotazioni", aggiorna la lista
                    if (tabId === 'my-bookings') {
                        renderMyBookings();
                    }
                });
            });
            
            // Navbar per admin
            document.querySelectorAll('#admin-app .nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('#admin-app .nav-item').forEach(nav => {
                        nav.classList.remove('admin-active');
                        nav.classList.remove('active');
                    });
                    this.classList.add('admin-active');
                    this.classList.add('active');
                    
                    document.querySelectorAll('#admin-app .tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Carica i dati specifici per la tab
                    if (tabId === 'manage-laundry') {
                        renderAdminLaundryList();
                    } else if (tabId === 'manage-rooms') {
                        renderAdminRoomsList();
                    } else if (tabId === 'manage-users') {
                        renderAdminUsersList();
                    } else if (tabId === 'view-bookings') {
                        renderAdminBookings();
                    }
                });
            });
            
            // Selezione tipo lavanderia
            document.getElementById('laundry-type').addEventListener('change', function() {
                const type = this.value;
                const equipmentSelect = document.getElementById('laundry-equipment-select');
                const visualSelection = document.getElementById('laundry-equipment-visual');
                
                if (type) {
                    populateLaundryEquipmentSelect(type);
                    equipmentSelect.disabled = false;
                    
                    renderLaundryEquipmentVisualSelection(type);
                    visualSelection.style.display = 'block';
                } else {
                    equipmentSelect.innerHTML = '<option value="">Prima seleziona il tipo</option>';
                    equipmentSelect.disabled = true;
                    visualSelection.style.display = 'none';
                    selectedLaundryEquipmentId = null;
                }
            });
            
            // Selezione attrezzatura lavanderia dalla select
            document.getElementById('laundry-equipment-select').addEventListener('change', function() {
                selectedLaundryEquipmentId = this.value;
                updateLaundryVisualSelection(selectedLaundryEquipmentId);
            });
            
            // Prenotazione lavanderia
            document.getElementById('book-laundry-btn').addEventListener('click', async function() {
                const type = document.getElementById('laundry-type').value;
                const equipmentId = document.getElementById('laundry-equipment-select').value;
                const date = document.getElementById('laundry-date').value;
                const startTime = document.getElementById('laundry-start').value;
                const endTime = document.getElementById('laundry-end').value;
                
                // Validazione
                if (!type || !equipmentId || !date || !startTime || !endTime) {
                    alert('Per favore, compila tutti i campi.');
                    return;
                }
                
                if (startTime >= endTime) {
                    alert('L\'ora di fine deve essere successiva all\'ora di inizio.');
                    return;
                }
                
                // Trova l'attrezzatura
                const equipment = laundryEquipment.find(eq => eq.id === equipmentId);
                if (!equipment) {
                    alert('Apparecchio non trovato.');
                    return;
                }
                
                // Controlla conflitti
                const isBooked = bookings.some(booking => 
  		booking.equipment_id === equipment.id && 
  		booking.booking_date === date &&  // ← booking_date invece di date
  		booking.status === "active" &&
                    ((startTime >= formatTime(booking.start_time) && startTime < formatTime(booking.end_time)) ||
                     (endTime > formatTime(booking.start_time) && endTime <= formatTime(booking.end_time)) ||
                     (startTime <= formatTime(booking.start_time) && endTime >= formatTime(booking.end_time)))
                );
                
                if (isBooked) {
                    alert('Questo apparecchio è già prenotato per l\'orario selezionato. Prova con un orario diverso.');
                    return;
                }
                
                // Trova l'alloggio dell'utente
                const userRoom = rooms.find(r => r.id === currentUser.room_id);
                
                try {
                    // Crea la prenotazione nel database
                    const newBooking = await createBooking({
                        id: generateId(),
                        type: "laundry",
                        equipmentType: type,
                        equipmentId: equipment.id,
                        equipmentName: equipment.name,
                        userId: currentUser.id,
                        userName: currentUser.name,
                        userRoomId: currentUser.room_id,
                        userRoomCode: userRoom ? userRoom.code : '',
                        date: date,
                        startTime: formatTime(startTime),
                        endTime: formatTime(endTime)
                    });
                    
                    // Aggiorna i dati locali
                    bookings.push(newBooking);
                    
                    // Reset form
                    const today = getFormattedDate(new Date());
                    document.getElementById('laundry-date').value = today;
                    document.getElementById('laundry-start').value = "10:00";
                    document.getElementById('laundry-end').value = "12:00";
                    document.getElementById('laundry-type').value = "";
                    document.getElementById('laundry-equipment-select').innerHTML = '<option value="">Prima seleziona il tipo</option>';
                    document.getElementById('laundry-equipment-select').disabled = true;
                    document.getElementById('laundry-equipment-visual').style.display = 'none';
                    selectedLaundryEquipmentId = null;
                    
                    // Aggiorna l'interfaccia
                    renderLaundryEquipment();
                    renderMyBookings();
                    
                    // Chiedi se vuoi salvare sul calendario
                    if (confirm(`Prenotazione confermata per ${equipment.name} il ${date} dalle ${formatTime(startTime)} alle ${formatTime(endTime)}\n\nVuoi salvare la prenotazione nel tuo calendario?`)) {
                        downloadICSFile(newBooking);
                    }
                    
                } catch (error) {
                    alert('Errore durante la creazione della prenotazione: ' + error.message);
                }
            });
            
            // Prenotazione palestra
            document.getElementById('book-gym-btn').addEventListener('click', async function() {
                const date = document.getElementById('gym-date').value;
                const startTime = document.getElementById('gym-start').value;
                const endTime = document.getElementById('gym-end').value;
                const capacity = document.getElementById('gym-capacity').value;
                const notes = document.getElementById('gym-notes').value;
                
                // Validazione
                if (!date || !startTime || !endTime || !capacity) {
                    alert('Per favore, compila tutti i campi obbligatori.');
                    return;
                }
                
                if (startTime >= endTime) {
                    alert('L\'ora di fine deve essere successiva all\'ora di inizio.');
                    return;
                }
                
                // Controlla se la palestra è già prenotata per l'orario selezionato
                const isBooked = bookings.some(booking => 
                    booking.type === "gym" &&
                    booking.booking_date === date &&
                    booking.status === "active" &&
                    ((startTime >= formatTime(booking.start_time) && startTime < formatTime(booking.end_time)) ||
                     (endTime > formatTime(booking.start_time) && endTime <= formatTime(booking.end_time)) ||
                     (startTime <= formatTime(booking.start_time) && endTime >= formatTime(booking.end_time)))
                );
                
                if (isBooked) {
                    alert('La palestra è già prenotata per l\'orario selezionato. Prova con un orario diverso.');
                    return;
                }
                
                // Trova l'alloggio dell'utente
                const userRoom = rooms.find(r => r.id === currentUser.room_id);
                
                try {
                    // Crea la prenotazione nel database
                    const newBooking = await createBooking({
                        id: generateId(),
                        type: "gym",
                        equipmentType: "gym_room",
                        equipmentId: "gym-room",
                        equipmentName: "Palestra",
                        userId: currentUser.id,
                        userName: currentUser.name,
                        userRoomId: currentUser.room_id,
                        userRoomCode: userRoom ? userRoom.code : '',
                        date: date,
                        startTime: formatTime(startTime),
                        endTime: formatTime(endTime),
                        capacity: parseInt(capacity),
                        notes: notes
                    });
                    
                    // Aggiorna i dati locali
                    bookings.push(newBooking);
                    
                    // Reset form
                    const today = getFormattedDate(new Date());
                    document.getElementById('gym-date').value = today;
                    document.getElementById('gym-start').value = "08:00";
                    document.getElementById('gym-end').value = "09:00";
                    document.getElementById('gym-capacity').value = "2";
                    document.getElementById('gym-notes').value = "";
                    
                    // Aggiorna l'interfaccia
                    renderGymSchedule();
                    renderMyBookings();
                    
                    // Chiedi se vuoi salvare sul calendario
                    if (confirm(`Prenotazione confermata per la Palestra il ${date} dalle ${formatTime(startTime)} alle ${formatTime(endTime)} per ${capacity} persone\n\nVuoi salvare la prenotazione nel tuo calendario?`)) {
                        downloadICSFile(newBooking);
                    }
                    
                } catch (error) {
                    alert('Errore durante la creazione della prenotazione: ' + error.message);
                }
            });
            
            // Gestione modali admin
            document.getElementById('add-laundry-btn')?.addEventListener('click', function() {
                openAddLaundryModal();
            });
            
            document.getElementById('add-room-btn')?.addEventListener('click', function() {
                openAddRoomModal();
            });
            
            document.getElementById('add-new-laundry-btn')?.addEventListener('click', function() {
                openAddLaundryModal();
            });
            
            document.getElementById('add-new-room-btn')?.addEventListener('click', function() {
                openAddRoomModal();
            });
            
            document.getElementById('view-all-bookings-btn')?.addEventListener('click', function() {
                document.querySelectorAll('#admin-app .nav-item').forEach(nav => {
                    nav.classList.remove('admin-active');
                });
                document.querySelector('[data-tab="view-bookings"]').classList.add('admin-active');
                
                document.querySelectorAll('#admin-app .tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById('view-bookings').classList.add('active');
                
                renderAdminBookings();
            });
            
            // Salva nuova attrezzatura lavanderia
            document.getElementById('save-laundry-btn')?.addEventListener('click', async function() {
                const type = document.getElementById('new-laundry-type').value;
                const name = document.getElementById('new-laundry-name').value;
                const position = document.getElementById('new-laundry-position').value;
                const description = document.getElementById('new-laundry-description').value;
                
                if (!name || !position) {
                    alert('Per favore, compila almeno il nome e la posizione.');
                    return;
                }
                
                try {
                    const equipmentId = `${type}-${generateId().substring(0, 8)}`;
                    
                    await addLaundryEquipment({
                        id: equipmentId,
                        name: name,
                        type: type,
                        position: position,
                        description: description,
                        addedBy: currentUser.username || 'admin'
                    });
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    // Chiudi il modale
                    document.getElementById('add-laundry-modal').style.display = 'none';
                    
                    // Reset form
                    document.getElementById('new-laundry-name').value = '';
                    document.getElementById('new-laundry-position').value = '';
                    document.getElementById('new-laundry-description').value = '';
                    
                    // Aggiorna le interfacce
                    renderAdminLaundryList();
                    updateAdminStats();
                    
                    alert('Attrezzatura aggiunta con successo!');
                    
                } catch (error) {
                    alert('Errore durante l\'aggiunta dell\'attrezzatura: ' + error.message);
                }
            });
            
            // Salva nuovo/modifica alloggio
document.getElementById('save-room-btn')?.addEventListener('click', async function() {
  console.log('🖱️ CLICK SALVA ALLOGGIO');
  
  const roomId = document.getElementById('edit-room-id').value;
  const code = document.getElementById('new-room-code').value.trim();
  const name = document.getElementById('new-room-name').value.trim();
  const type = document.getElementById('new-room-type').value;
  const capacity = parseInt(document.getElementById('new-room-capacity').value);
  const floor = document.getElementById('new-room-floor').value.trim();
  const features = document.getElementById('new-room-features').value.trim();
  const status = document.getElementById('new-room-status').value;
  
  console.log('📝 DATI DEL FORM:', {
    roomId, code, name, type, capacity, floor, features, status
  });
  
  // Validazione
  if (!code || !name || !type || isNaN(capacity)) {
    alert('Per favore, compila correttamente tutti i campi obbligatori.');
    return;
  }
  
  try {
    // Prepara i dati CON la struttura corretta
    const roomData = {
      code: code,
      name: name,
      type: type,
      capacity: capacity,
      floor: floor || null,
      features: features || null,
      status: status || 'active'
    };
    
    console.log('📤 Dati preparati:', roomData);
    
    let result;
    
    if (roomId) {
      console.log(`🔧 MODIFICA alloggio ID: ${roomId}`);
      result = await updateRoom(roomId, roomData);
    } else {
      console.log('➕ AGGIUNGI nuovo alloggio');
      result = await addRoom(roomData);
    }
    
    console.log('✅ Risultato operazione:', result);
    
    // Ricarica i dati
    console.log('🔄 Ricarica dati...');
    await loadAllData();
    
    // Aggiorna UI
    renderAdminRoomsList();
    updateAdminStats();
    populateRoomSelects();
    
    // Chiudi modale
    document.getElementById('add-room-modal').style.display = 'none';
    
    // Reset form
    document.getElementById('edit-room-id').value = '';
    document.getElementById('new-room-code').value = '';
    document.getElementById('new-room-name').value = '';
    document.getElementById('new-room-type').value = 'single';
    document.getElementById('new-room-capacity').value = '2';
    document.getElementById('new-room-floor').value = '';
    document.getElementById('new-room-features').value = '';
    document.getElementById('new-room-status').value = 'active';
    document.getElementById('room-modal-title').textContent = 'Aggiungi Nuovo Alloggio';
    
    alert('✅ Alloggio salvato con successo!');
    
  } catch (error) {
    console.error('❌ ERRORE durante salvataggio:', error);
    
    let errorMessage = 'Errore durante il salvataggio: ';
    
    if (error.message.includes('duplicate key')) {
      errorMessage = `Il codice alloggio "${code}" è già in uso. Usa un codice diverso.`;
    } else if (error.message.includes('permission denied')) {
      errorMessage = 'Permessi insufficienti. Controlla le policy RLS.';
    } else if (error.message.includes('invalid input syntax')) {
      errorMessage = 'Formato dati non valido. Controlla i campi numerici.';
    } else {
      errorMessage += error.message;
    }
    
    alert(errorMessage);
  }
});
            
            // Salva modifica utente
            document.getElementById('save-user-btn')?.addEventListener('click', async function() {
                const userId = parseInt(document.getElementById('edit-user-id').value);
                const name = document.getElementById('edit-user-name').value;
                const email = document.getElementById('edit-user-email').value;
                const password = document.getElementById('edit-user-password').value;
                const roomId = document.getElementById('edit-user-room').value;
                const phone = document.getElementById('edit-user-phone').value;
                
                // Validazione
                if (!name || !email || !roomId) {
                    alert('Per favore, compila tutti i campi obbligatori.');
                    return;
                }
                
                try {
                    const updates = {
                        name: name,
                        email: email,
                        room_id: parseInt(roomId),
                        phone: phone || ''
                    };
                    
                    // Se è stata fornita una nuova password, aggiornala
                    if (password.trim() !== '') {
                        updates.password = password;
                    }
                    
                    await updateUser(userId, updates);
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    // Chiudi il modale
                    document.getElementById('edit-user-modal').style.display = 'none';
                    
                    // Reset form
                    document.getElementById('edit-user-id').value = '';
                    document.getElementById('edit-user-name').value = '';
                    document.getElementById('edit-user-email').value = '';
                    document.getElementById('edit-user-password').value = '';
                    document.getElementById('edit-user-room').value = '';
                    document.getElementById('edit-user-phone').value = '';
                    
                    // Aggiorna l'interfaccia
                    renderAdminUsersList();
                    
                    alert('Ospite modificato con successo!');
                    
                } catch (error) {
                    if (error.message.includes('duplicate key')) {
                        alert('Questa email è già registrata da un altro ospite.');
                    } else {
                        alert('Errore durante la modifica dell\'ospite: ' + error.message);
                    }
                }
            });
            
            // Chiudi modali
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Chiudi modale cliccando fuori
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // ==============================================
            // FUNZIONI DI RENDER
            // ==============================================
            
            function renderLaundryEquipment() {
                const container = document.getElementById('laundry-equipment');
                if (!container) return;
                
                container.innerHTML = '';
                
                laundryEquipment.forEach(eq => {
                    // Trova le prenotazioni per questa apparecchiatura
                    const equipmentBookings = bookings.filter(booking => 
                        booking.equipment_id === eq.id && 
                        booking.status === "active"
                    );
                    
                    // Determina se è attualmente disponibile
                    const now = new Date();
                    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    const today = getFormattedDate(now);
                    
                    const isCurrentlyBooked = equipmentBookings.some(booking => 
                        booking.booking_date === today &&
                        currentTime >= formatTime(booking.start_time) &&
                        currentTime <= formatTime(booking.end_time)
                    );
                    
                    const card = document.createElement('div');
                    card.className = 'equipment-card';
                    
                    card.innerHTML = `
                        <div class="equipment-header">
                            <h3>${eq.name}</h3>
                            <div class="equipment-status ${isCurrentlyBooked ? 'busy' : ''}">
                                ${isCurrentlyBooked ? 'Occupato' : 'Disponibile'}
                            </div>
                        </div>
                        <div class="equipment-body">
                            <div class="equipment-info">
                                <div><i class="fas fa-${eq.type === 'washer' ? 'soap' : 'wind'}"></i> ${eq.type === 'washer' ? 'Lavatrice' : 'Asciugatrice'}</div>
                                <div><i class="fas fa-map-marker-alt"></i> ${eq.position}</div>
                            </div>
                            <p><small>${eq.description || ''}</small></p>
                            
                            ${equipmentBookings.length > 0 ? `
                            <div class="booking-list">
                                <h4>Prenotazioni:</h4>
                                ${equipmentBookings.map(booking => `
                                    <div class="booking-item ${booking.user_id === currentUser?.id ? 'user-booking' : ''}">
                                        <div>
                                            <div><strong>${booking.booking_date}</strong> ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</div>
                                            <div><small>${booking.user_name} (Alloggio ${booking.user_room_code})</small></div>
                                        </div>
                                        ${booking.user_id === currentUser?.id ? `
                                        <div class="booking-actions">
                                            <button class="btn-edit" data-id="${booking.id}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn-delete" data-id="${booking.id}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ` : '<p>Nessuna prenotazione attiva</p>'}
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Aggiungi event listeners per i pulsanti di modifica/eliminazione
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        openEditModal(bookingId);
                    });
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        if (confirm('Sei sicuro di voler cancellare questa prenotazione?')) {
                            deleteBookingLocal(bookingId);
                        }
                    });
                });
            }
            
            function renderGymSchedule() {
                const container = document.getElementById('gym-schedule');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Ottieni la data selezionata
                const selectedDate = document.getElementById('gym-date') ? document.getElementById('gym-date').value : getFormattedDate(new Date());
                
                // Filtra le prenotazioni della palestra per la data selezionata
                const gymBookings = bookings.filter(booking => 
                    booking.type === "gym" && 
                    booking.booking_date === selectedDate &&
                    booking.status === "active"
                ).sort((a, b) => a.start_time.localeCompare(b.start_time));
                
                const openingTime = "06:00";
                const closingTime = "23:00";
                
                if (gymBookings.length === 0) {
                    container.innerHTML = `
                        <div class="equipment-card">
                            <div class="equipment-header">
                                <h3>Palestra - ${selectedDate}</h3>
                                <div class="equipment-status">Tutto libero</div>
                            </div>
                            <div class="equipment-body">
                                <p>Nessuna prenotazione per oggi. La palestra è completamente disponibile dalle ${openingTime} alle ${closingTime}.</p>
                                <p><strong>Orari di apertura:</strong> ${openingTime} - ${closingTime}</p>
                                <p><strong>Capacità massima:</strong> 6 persone</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Determina se la palestra è attualmente occupata
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const today = getFormattedDate(now);
                
                const isCurrentlyBooked = gymBookings.some(booking => 
                    (selectedDate === today) &&
                    currentTime >= formatTime(booking.start_time) &&
                    currentTime <= formatTime(booking.end_time)
                );
                
                const card = document.createElement('div');
                card.className = 'equipment-card';
                
                card.innerHTML = `
                    <div class="equipment-header">
                        <h3>Palestra - ${selectedDate}</h3>
                        <div class="equipment-status ${isCurrentlyBooked ? 'busy' : ''}">
                            ${isCurrentlyBooked ? 'Occupata' : 'Disponibile'}
                        </div>
                    </div>
                    <div class="equipment-body">
                        <div class="equipment-info">
                            <div><i class="fas fa-clock"></i> Orari: ${openingTime} - ${closingTime}</div>
                            <div><i class="fas fa-users"></i> Capacità max: 6 persone</div>
                        </div>
                        
                        <div class="booking-list">
                            <h4>Prenotazioni del giorno:</h4>
                            ${gymBookings.map(booking => `
                                <div class="booking-item ${booking.user_id === currentUser?.id ? 'user-booking' : ''}">
                                    <div>
                                        <div><strong>${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</strong></div>
                                        <div>${booking.user_name} (Alloggio ${booking.user_room_code})</div>
                                        <div><small>Persone: ${booking.capacity || 1}</small></div>
                                        ${booking.notes ? `<div><small>Note: ${booking.notes}</small></div>` : ''}
                                    </div>
                                    ${booking.user_id === currentUser?.id ? `
                                    <div class="booking-actions">
                                        <button class="btn-edit" data-id="${booking.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-delete" data-id="${booking.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Aggiungi event listeners
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        openEditModal(bookingId);
                    });
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        if (confirm('Sei sicuro di voler cancellare questa prenotazione?')) {
                            deleteBookingLocal(bookingId);
                            renderGymSchedule();
                        }
                    });
                });
            }
            
            function renderMyBookings() {
                const container = document.getElementById('my-bookings-list');
                if (!container || !currentUser) return;
                
                const myBookings = bookings.filter(booking => 
                    booking.user_id === currentUser.id && booking.status === "active"
                );
                
                if (myBookings.length === 0) {
                    container.innerHTML = '<p>Non hai prenotazioni attive.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Separa prenotazioni lavanderia e palestra
                const laundryBookings = myBookings.filter(b => b.type === 'laundry');
                const gymBookings = myBookings.filter(b => b.type === 'gym');
                
                if (laundryBookings.length > 0) {
                    const section = document.createElement('div');
                    section.innerHTML = `
                        <h3><i class="fas fa-tshirt"></i> Prenotazioni Lavanderia</h3>
                        <div class="booking-list">
                            ${laundryBookings.map(booking => `
                                <div class="booking-item user-booking">
                                    <div>
                                        <div><strong>${booking.equipment_name}</strong></div>
                                        <div>${booking.booking_date} ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</div>
                                    </div>
                                    <div class="booking-actions">
                                        <button class="btn-edit" data-id="${booking.id}">
                                            <i class="fas fa-edit"></i> Modifica
                                        </button>
                                        <button class="btn-calendar btn-small" data-id="${booking.id}" title="Aggiungi al calendario">
                                            <i class="fas fa-calendar-plus"></i>
                                        </button>
                                        <button class="btn-delete" data-id="${booking.id}">
                                            <i class="fas fa-trash"></i> Elimina
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                }
                
                if (gymBookings.length > 0) {
                    const section = document.createElement('div');
                    section.innerHTML = `
                        <h3><i class="fas fa-dumbbell"></i> Prenotazioni Palestra</h3>
                        <div class="booking-list">
                            ${gymBookings.map(booking => `
                                <div class="booking-item user-booking">
                                    <div>
                                        <div><strong>Palestra</strong></div>
                                        <div>${booking.booking_date} ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</div>
                                        <div><small>Persone: ${booking.capacity || 1}</small></div>
                                        ${booking.notes ? `<div><small>Note: ${booking.notes}</small></div>` : ''}
                                    </div>
                                    <div class="booking-actions">
                                        <button class="btn-edit" data-id="${booking.id}">
                                            <i class="fas fa-edit"></i> Modifica
                                        </button>
                                        <button class="btn-calendar btn-small" data-id="${booking.id}" title="Aggiungi al calendario">
                                            <i class="fas fa-calendar-plus"></i>
                                        </button>
                                        <button class="btn-delete" data-id="${booking.id}">
                                            <i class="fas fa-trash"></i> Elimina
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                }
                
                // Aggiungi event listeners
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        openEditModal(bookingId);
                    });
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        if (confirm('Sei sicuro di voler cancellare questa prenotazione?')) {
                            deleteBookingLocal(bookingId);
                        }
                    });
                });
                
                document.querySelectorAll('.btn-calendar').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        const booking = bookings.find(b => b.id === bookingId);
                        if (booking) {
                            downloadICSFile(booking);
                        }
                    });
                });
            }
            
            function renderAdminLaundryList() {
                const container = document.getElementById('admin-laundry-list');
                if (!container) return;
                
                if (laundryEquipment.length === 0) {
                    container.innerHTML = '<p>Nessuna attrezzatura di lavanderia registrata.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                laundryEquipment.forEach(eq => {
                    const item = document.createElement('div');
                    item.className = 'equipment-list-item';
                    
                    item.innerHTML = `
                        <div>
                            <div><strong>${eq.name}</strong> - ${eq.type === 'washer' ? 'Lavatrice' : 'Asciugatrice'}</div>
                            <div><small>Posizione: ${eq.position}</small></div>
                            <div><small>${eq.description || ''}</small></div>
                            <div><small>Aggiunto da: ${eq.added_by || 'admin'}</small></div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn-edit btn-small edit-laundry-btn" data-id="${eq.id}">
                                <i class="fas fa-edit"></i> Modifica
                            </button>
                            <button class="btn-delete btn-small" data-id="${eq.id}" data-type="laundry">
                                <i class="fas fa-trash"></i> Rimuovi
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
                
                // Aggiungi event listeners
                document.querySelectorAll('[data-type="laundry"].btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const equipmentId = this.getAttribute('data-id');
                        if (confirm('Sei sicuro di voler rimuovere questa attrezzatura?')) {
                            deleteLaundryEquipmentLocal(equipmentId);
                        }
                    });
                });
                
                document.querySelectorAll('.edit-laundry-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Implementa la modifica se necessario
                        alert('Funzione di modifica da implementare');
                    });
                });
            }
            
            function renderAdminRoomsList() {
                const container = document.getElementById('admin-rooms-list');
                if (!container) return;
                
                if (rooms.length === 0) {
                    container.innerHTML = '<p>Nessun alloggio registrato.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                rooms.forEach(room => {
                    // Conta gli ospiti registrati in questo alloggio
                    const guestsInRoom = users.filter(u => u.room_id === room.id).length;
                    
                    const item = document.createElement('div');
                    item.className = 'room-list-item';
                    
                    let borderColor = 'var(--admin-color)';
                    if (room.status === 'maintenance') borderColor = 'var(--warning-color)';
                    if (room.status === 'reserved') borderColor = 'var(--info-color)';
                    
                    item.style.borderLeftColor = borderColor;
                    
                    item.innerHTML = `
                        <div style="flex: 1;">
                            <div><strong>${room.code} - ${room.name}</strong></div>
                            <div class="room-info" style="margin-top: 0.5rem;">
                                <div class="room-info-item">
                                    <div><small><i class="fas fa-bed"></i> Tipo: ${getRoomTypeLabel(room.type)}</small></div>
                                    <div><small><i class="fas fa-users"></i> Capacità: ${room.capacity} persone</small></div>
                                </div>
                                <div class="room-info-item">
                                    <div><small><i class="fas fa-layer-group"></i> Piano: ${room.floor}</small></div>
                                    <div><small><i class="fas fa-user-check"></i> Ospiti: ${guestsInRoom}</small></div>
                                </div>
                            </div>
                            <div><small><i class="fas fa-info-circle"></i> ${room.features || 'Nessuna caratteristica specificata'}</small></div>
                            <div><small><i class="fas fa-circle" style="color: ${room.status === 'active' ? 'var(--success-color)' : room.status === 'maintenance' ? 'var(--warning-color)' : 'var(--info-color)'}"></i> Stato: ${getRoomStatusLabel(room.status)}</small></div>
                            <div><small><i class="fas fa-calendar-plus"></i> Creato: ${new Date(room.created_at).toLocaleDateString('it-IT')}</small></div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn-edit btn-small edit-room-btn" data-id="${room.id}">
                                <i class="fas fa-edit"></i> Modifica
                            </button>
                            <button class="btn-delete btn-small" data-id="${room.id}" data-type="room">
                                <i class="fas fa-trash"></i> Rimuovi
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
                
                // Aggiungi event listeners
                document.querySelectorAll('.edit-room-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const roomId = parseInt(this.getAttribute('data-id'));
                        openEditRoomModal(roomId);
                    });
                });
                
                document.querySelectorAll('[data-type="room"].btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const roomId = parseInt(this.getAttribute('data-id'));
                        if (confirm('Sei sicuro di voler rimuovere questo alloggio?')) {
                            deleteRoomLocal(roomId);
                        }
                    });
                });
            }
            
function renderAdminUsersList() {
    const container = document.getElementById('admin-users-list');
    if (!container) return;
    
    if (users.length === 0) {
        container.innerHTML = '<p>Nessun ospite registrato.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    users.forEach(user => {
        const userRoom = rooms.find(r => r.id === user.room_id);
        
        // MODIFICA QUI: Controlla TUTTE le prenotazioni, non solo quelle attive
        const userBookings = bookings.filter(b => b.user_id === user.id);
        const hasActiveBookings = userBookings.some(b => b.status === "active");
        const hasAnyBookings = userBookings.length > 0;
        
        const item = document.createElement('div');
        item.className = 'equipment-list-item';
        
        // Conta le prenotazioni attive e totali
        const activeBookingsCount = userBookings.filter(b => b.status === "active").length;
        const cancelledBookingsCount = userBookings.filter(b => b.status === "cancelled").length;
        
        item.innerHTML = `
            <div style="flex: 1;">
                <div><strong>${user.name}</strong></div>
                <div><small>Email: ${user.email}</small></div>
                <div><small>Alloggio: ${userRoom ? `${userRoom.code} - ${userRoom.name}` : user.room_id}</small></div>
                <div><small>Telefono: ${user.phone || 'Non fornito'}</small></div>
                <div><small>Registrato il: ${new Date(user.registered_at).toLocaleDateString('it-IT')}</small></div>
                <div><small>Prenotazioni attive: ${activeBookingsCount}</small></div>
                <div><small>Prenotazioni cancellate nello storico: ${cancelledBookingsCount}</small></div>
                ${hasActiveBookings ? 
                    `<div style="color: var(--warning-color); font-size: 0.85rem; margin-top: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> Non può essere eliminato perché ha prenotazioni attive
                    </div>` : 
                    hasAnyBookings ?
                    `<div style="color: var(--info-color); font-size: 0.85rem; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Può essere eliminato (ha solo prenotazioni cancellate nello storico)
                    </div>` : ''
                }
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn-edit btn-small edit-user-btn" data-id="${user.id}">
                    <i class="fas fa-edit"></i> Modifica
                </button>
                <button class="btn-delete btn-small" data-id="${user.id}" data-type="user" 
                    ${hasActiveBookings ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    <i class="fas fa-trash"></i> ${hasActiveBookings ? 'Non eliminabile' : hasAnyBookings ? 'Elimina (ha storico)' : 'Elimina'}
                </button>
            </div>
        `;
        
        container.appendChild(item);
    });
    
    // Aggiungi event listeners
    document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            openEditUserModal(userId);
        });
    });
    
    document.querySelectorAll('[data-type="user"].btn-delete:not([disabled])').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            if (confirm('Sei sicuro di voler rimuovere questo ospite?')) {
                deleteUserLocal(userId);
            }
        });
    });
}
            
            function renderAdminBookings() {
                const laundryContainer = document.getElementById('admin-laundry-bookings');
                const gymContainer = document.getElementById('admin-gym-bookings');
                
                if (!laundryContainer || !gymContainer) return;
                
                const activeBookings = bookings.filter(b => b.status === "active");
                const laundryBookings = activeBookings.filter(b => b.type === 'laundry');
                const gymBookings = activeBookings.filter(b => b.type === 'gym');
                
                // Prenotazioni lavanderia
                if (laundryBookings.length === 0) {
                    laundryContainer.innerHTML = '<p>Nessuna prenotazione attiva per la lavanderia.</p>';
                } else {
                    laundryContainer.innerHTML = `
                        <div class="booking-list">
                            ${laundryBookings.map(booking => `
                                <div class="booking-item">
                                    <div>
                                        <div><strong>${booking.equipment_name}</strong></div>
                                        <div>${booking.booking_date} ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</div>
                                        <div><small>Prenotato da: ${booking.user_name} (Alloggio ${booking.user_room_code})</small></div>
                                    </div>
                                    <div class="booking-actions">
                                        <button class="btn-delete btn-small" data-id="${booking.id}">
                                            <i class="fas fa-trash"></i> Annulla
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Prenotazioni palestra
                if (gymBookings.length === 0) {
                    gymContainer.innerHTML = '<p>Nessuna prenotazione attiva per la palestra.</p>';
                } else {
                    gymContainer.innerHTML = `
                        <div class="booking-list">
                            ${gymBookings.map(booking => `
                                <div class="booking-item">
                                    <div>
                                        <div><strong>${booking.equipment_name}</strong></div>
                                        <div>${booking.booking_date} ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</div>
                                        <div><small>Prenotato da: ${booking.user_name} (Alloggio ${booking.user_room_code})</small></div>
                                    </div>
                                    <div class="booking-actions">
                                        <button class="btn-delete btn-small" data-id="${booking.id}">
                                            <i class="fas fa-trash"></i> Annulla
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Aggiungi event listeners
                document.querySelectorAll('#admin-laundry-bookings .btn-delete, #admin-gym-bookings .btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookingId = this.getAttribute('data-id');
                        if (confirm('Sei sicuro di voler annullare questa prenotazione?')) {
                            deleteBookingLocal(bookingId);
                            renderAdminBookings();
                            updateAdminStats();
                        }
                    });
                });
            }
            
            function updateAdminStats() {
                // Conta alloggi attivi
                const activeRooms = rooms.filter(r => r.status === "active").length;
                const roomsCount = document.getElementById('rooms-count');
                if (roomsCount) roomsCount.textContent = activeRooms;
                
                // Conta attrezzature
                const laundryCount = document.getElementById('laundry-count');
                if (laundryCount) laundryCount.textContent = laundryEquipment.length;
                
                // Conta prenotazioni attive
                const activeBookings = bookings.filter(b => b.status === "active").length;
                const activeBookingsCount = document.getElementById('active-bookings-count');
                if (activeBookingsCount) activeBookingsCount.textContent = activeBookings;
                
                // Conta ospiti
                const usersCount = document.getElementById('users-count');
                if (usersCount) usersCount.textContent = users.length;
                
                // Calcola occupazione alloggi
                const roomsWithGuests = new Set(users.map(u => u.room_id)).size;
                const occupancyRate = activeRooms > 0 ? Math.round((roomsWithGuests / activeRooms) * 100) : 0;
                const roomOccupancy = document.getElementById('room-occupancy');
                if (roomOccupancy) roomOccupancy.textContent = `${occupancyRate}%`;
            }
            
            // ==============================================
            // FUNZIONI AUSILIARIE
            // ==============================================
            
            function getRoomTypeLabel(type) {
                const types = {
                    'single': 'Camera Singola',
                    'double': 'Camera Doppia',
                    'twin': 'Camera con due letti singoli',
                    'suite': 'Suite',
                    'apartment': 'Appartamento',
                    'family': 'Familiare'
                };
                return types[type] || type;
            }
            
            function getRoomStatusLabel(status) {
                const statuses = {
                    'active': 'Attivo e disponibile',
                    'maintenance': 'In manutenzione',
                    'reserved': 'Riservato'
                };
                return statuses[status] || status;
            }
            
            function openAddLaundryModal() {
                document.getElementById('add-laundry-modal').style.display = 'flex';
            }
            
            function openAddRoomModal() {
                document.getElementById('edit-room-id').value = '';
                document.getElementById('new-room-code').value = '';
                document.getElementById('new-room-name').value = '';
                document.getElementById('new-room-type').value = 'single';
                document.getElementById('new-room-capacity').value = '2';
                document.getElementById('new-room-floor').value = '';
                document.getElementById('new-room-features').value = '';
                document.getElementById('new-room-status').value = 'active';
                document.getElementById('room-modal-title').textContent = 'Aggiungi Nuovo Alloggio';
                document.getElementById('add-room-modal').style.display = 'flex';
            }
            
            function openEditRoomModal(roomId) {
                const room = rooms.find(r => r.id === roomId);
                if (!room) return;
                
                document.getElementById('edit-room-id').value = room.id;
                document.getElementById('new-room-code').value = room.code;
                document.getElementById('new-room-name').value = room.name;
                document.getElementById('new-room-type').value = room.type;
                document.getElementById('new-room-capacity').value = room.capacity;
                document.getElementById('new-room-floor').value = room.floor || '';
                document.getElementById('new-room-features').value = room.features || '';
                document.getElementById('new-room-status').value = room.status;
                document.getElementById('room-modal-title').textContent = 'Modifica Alloggio';
                document.getElementById('add-room-modal').style.display = 'flex';
            }
            
            function openEditUserModal(userId) {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const userRoom = rooms.find(r => r.id === user.room_id);
                
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-password').value = '';
                document.getElementById('edit-user-phone').value = user.phone || '';
                
                // Popola la select degli alloggi
                const roomSelect = document.getElementById('edit-user-room');
                roomSelect.innerHTML = '<option value="">Seleziona alloggio</option>';
                
                rooms.filter(room => room.status === "active").forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = `${room.code} - ${room.name}`;
                    if (user.room_id === room.id) {
                        option.selected = true;
                    }
                    roomSelect.appendChild(option);
                });
                
                document.getElementById('edit-user-modal').style.display = 'flex';
            }
            
            function openEditModal(bookingId) {
                const booking = bookings.find(b => b.id === bookingId);
                if (!booking) return;
                
                const form = document.getElementById('edit-booking-form');
                
                form.innerHTML = `
                    <input type="hidden" id="edit-booking-id" value="${booking.id}">
                    <div class="form-group">
                        <label for="edit-equipment">${booking.type === 'laundry' ? 'Apparecchio' : 'Attrezzatura'}:</label>
                        <input type="text" id="edit-equipment" value="${booking.equipment_name}" readonly>
                        <input type="hidden" id="edit-booking-type" value="${booking.type}">
                        <input type="hidden" id="edit-equipment-id" value="${booking.equipment_id}">
                    </div>
                    <div class="form-group">
                        <label for="edit-date">Data:</label>
                        <input type="date" id="edit-date" value="${booking.booking_date}">
                    </div>
                    <div class="form-group">
                        <label for="edit-start">Ora di inizio:</label>
                        <input type="time" id="edit-start" value="${formatTime(booking.start_time)}">
                    </div>
                    <div class="form-group">
                        <label for="edit-end">Ora di fine:</label>
                        <input type="time" id="edit-end" value="${formatTime(booking.end_time)}">
                    </div>
                    ${booking.type === 'gym' ? `
                    <div class="form-group">
                        <label for="edit-capacity">Numero di persone:</label>
                        <input type="number" id="edit-capacity" min="1" max="6" value="${booking.capacity || 1}">
                    </div>
                    <div class="form-group">
                        <label for="edit-notes">Note:</label>
                        <textarea id="edit-notes" rows="2">${booking.notes || ''}</textarea>
                    </div>
                    ` : ''}
                `;
                
                document.getElementById('edit-modal').style.display = 'flex';
                
                // Salva le modifiche
                document.getElementById('save-edit-btn').onclick = async function() {
                    const date = document.getElementById('edit-date').value;
                    const startTime = document.getElementById('edit-start').value;
                    const endTime = document.getElementById('edit-end').value;
                    
                    // Validazione
                    if (startTime >= endTime) {
                        alert('L\'ora di fine deve essere successiva all\'ora di inizio.');
                        return;
                    }
                    
                    const updates = {
                        date: date,
                        start_time: formatTime(startTime),
                        end_time: formatTime(endTime)
                    };
                    
                    if (booking.type === 'gym') {
                        updates.capacity = parseInt(document.getElementById('edit-capacity').value) || 1;
                        updates.notes = document.getElementById('edit-notes').value || '';
                    }
                    
                    try {
                        await updateBooking(booking.id, updates);
                        
                        // Ricarica i dati
                        await loadAllData();
                        
                        // Chiudi il modale
                        document.getElementById('edit-modal').style.display = 'none';
                        
                        // Aggiorna l'interfaccia
                        if (booking.type === 'laundry') {
                            renderLaundryEquipment();
                        } else {
                            renderGymSchedule();
                        }
                        renderMyBookings();
                        
                        if (isAdmin) {
                            renderAdminBookings();
                            updateAdminStats();
                        }
                        
                        alert('Prenotazione aggiornata con successo!');
                        
                    } catch (error) {
                        alert('Errore durante l\'aggiornamento della prenotazione: ' + error.message);
                    }
                };
                
                document.getElementById('cancel-edit-btn').onclick = function() {
                    document.getElementById('edit-modal').style.display = 'none';
                };
            }
            
            async function deleteBookingLocal(bookingId) {
                try {
                    await cancelBooking(bookingId);
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    // Aggiorna l'interfaccia
                    if (!isAdmin) {
                        renderLaundryEquipment();
                        renderGymSchedule();
                        renderMyBookings();
                    } else {
                        renderAdminBookings();
                        updateAdminStats();
                        renderAdminUsersList();
                    }
                    
                    alert('Prenotazione cancellata con successo!');
                    
                } catch (error) {
                    alert('Errore durante la cancellazione della prenotazione: ' + error.message);
                }
            }
            
            async function deleteLaundryEquipmentLocal(equipmentId) {
                try {
                    // Controlla se ci sono prenotazioni attive
                    const activeBookings = bookings.filter(b => 
                        b.equipment_id === equipmentId && 
                        b.status === "active"
                    );
                    
                    if (activeBookings.length > 0) {
                        alert('Non puoi rimuovere questa attrezzatura perché ha prenotazioni attive. Annulla prima le prenotazioni.');
                        return;
                    }
                    
                    await deleteLaundryEquipment(equipmentId);
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    // Aggiorna l'interfaccia
                    renderAdminLaundryList();
                    updateAdminStats();
                    
                    alert('Attrezzatura rimossa con successo!');
                    
                } catch (error) {
                    alert('Errore durante la rimozione dell\'attrezzatura: ' + error.message);
                }
            }
            
            async function deleteRoomLocal(roomId) {
                try {
                    // Controlla se ci sono ospiti registrati
                    const guestsInRoom = users.filter(u => u.room_id === roomId);
                    
                    if (guestsInRoom.length > 0) {
                        alert('Non puoi rimuovere questo alloggio perché ha ospiti registrati. Rimuovi prima gli ospiti.');
                        return;
                    }
                    
                    await deleteRoom(roomId);
                    
                    // Ricarica i dati
                    await loadAllData();
                    
                    // Aggiorna l'interfaccia
                    renderAdminRoomsList();
                    updateAdminStats();
                    populateRoomSelects();
                    
                    alert('Alloggio rimosso con successo!');
                    
                } catch (error) {
                    alert('Errore durante la rimozione dell\'alloggio: ' + error.message);
                }
            }
            
async function deleteUserLocal(userId) {
    try {
        // Controlla se ci sono prenotazioni ATTIVE
        const userBookings = bookings.filter(b => b.user_id === userId && b.status === "active");
        
        if (userBookings.length > 0) {
            alert(`❌ IMPOSSIBILE: L'ospite ha ${userBookings.length} prenotazione(i) attiva(e). Deve prima annullarle.`);
            return;
        }
        
        // Prova a eliminare l'utente
        const { error } = await supabaseClient
            .from('users')
            .delete()
            .eq('id', userId);
        
        if (error) {
            // Se c'è errore di foreign key, informa l'amministratore
            if (error.code === '23503') {
                alert(
                    '⚠️ ATTENZIONE: Non è possibile eliminare questo ospite a causa di un vincolo del database.\n\n' +
                    'Motivo: Ci sono prenotazioni nello storico (cancellate) che impediscono l\'eliminazione.\n\n' +
                    'Soluzione:\n' +
                    '1. Contatta l\'amministratore del database per modificare il vincolo\n' +
                    '2. Oppure imposta l\'ospite come "disattivato" invece di eliminarlo'
                );
                return;
            }
            throw error;
        }
        
        // Ricarica i dati
        await loadAllData();
        
        // Aggiorna l'interfaccia
        renderAdminUsersList();
        updateAdminStats();
        
        alert('✅ Ospite rimosso con successo!');
        
    } catch (error) {
        console.error('Errore durante la rimozione dell\'ospite:', error);
        alert('Errore durante la rimozione dell\'ospite: ' + error.message);
    }
}
            
            function renderLaundryEquipmentVisualSelection(type) {
                const container = document.getElementById('laundry-equipment-selection');
                const filteredEquipment = laundryEquipment.filter(eq => eq.type === type);
                const date = document.getElementById('laundry-date').value;
                
                if (filteredEquipment.length === 0) {
                    container.innerHTML = '<p>Nessun apparecchio disponibile di questo tipo.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                filteredEquipment.forEach(eq => {
                    const isBooked = bookings.some(booking => 
                        booking.equipment_id === eq.id && 
                        booking.booking_date === date &&
                        booking.status === "active"
                    );
                    
                    const option = document.createElement('div');
                    option.className = `equipment-option ${isBooked ? 'unavailable' : ''} ${selectedLaundryEquipmentId === eq.id ? 'selected' : ''}`;
                    option.setAttribute('data-id', eq.id);
                    
                    if (!isBooked) {
                        option.addEventListener('click', function() {
                            selectedLaundryEquipmentId = eq.id;
                            document.getElementById('laundry-equipment-select').value = eq.id;
                            updateLaundryVisualSelection(eq.id);
                        });
                    }
                    
                    option.innerHTML = `
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-${eq.type === 'washer' ? 'soap' : 'wind'}"></i>
                        </div>
                        <div style="font-weight: bold;">${eq.name}</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">${eq.position}</div>
                        <div style="font-size: 0.8rem;">${isBooked ? 'Prenotato' : 'Disponibile'}</div>
                    `;
                    
                    container.appendChild(option);
                });
            }
            
            function updateLaundryVisualSelection(equipmentId) {
                document.querySelectorAll('#laundry-equipment-selection .equipment-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                const selectedOption = document.querySelector(`#laundry-equipment-selection .equipment-option[data-id="${equipmentId}"]`);
                if (selectedOption && !selectedOption.classList.contains('unavailable')) {
                    selectedOption.classList.add('selected');
                }
            }
            
            function setupEquipmentSelection() {
                selectedLaundryEquipmentId = null;
                selectedGymEquipmentId = null;
            }
            
            // Funzione per scaricare file ICS (mantenuta dal codice originale)
            function generateICSFile(booking) {
                const startDateTime = new Date(`${booking.booking_date}T${formatTime(booking.start_time)}:00`);
                const endDateTime = new Date(`${booking.booking_date}T${formatTime(booking.end_time)}:00`);
                
                function formatDateForICS(date) {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                }
                
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Sala Assemblee Caltanissetta//Prenotazioni//IT',
                    'BEGIN:VEVENT',
                    `UID:${booking.id}@sala-assemblee-caltanissetta.it`,
                    `DTSTAMP:${formatDateForICS(new Date())}`,
                    `DTSTART:${formatDateForICS(startDateTime)}`,
                    `DTEND:${formatDateForICS(endDateTime)}`,
                    `SUMMARY:Prenotazione ${booking.type === 'laundry' ? 'Lavanderia' : 'Palestra'}: ${booking.equipment_name}`,
                    `DESCRIPTION:Prenotazione per ${booking.user_name} (Alloggio ${booking.user_room_code})\\nTipo: ${booking.type === 'laundry' ? 'Lavanderia' : 'Palestra'}\\nAttrezzatura: ${booking.equipment_name}\\nData: ${booking.booking_date}\\nOrario: ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}`,
                    `LOCATION:Sala delle Assemblee, Caltanissetta`,
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\r\n');
                
                return icsContent;
            }
            
            function downloadICSFile(booking) {
                const icsContent = generateICSFile(booking);
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `prenotazione-${booking.type}-${booking.booking_date}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                return true;
            }
            
        });
    </script>
</body>
</html>
